<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayaan's Timetable Maker</title>
    <!-- Load Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React, ReactDOM, and Babel for JSX compilation -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load PDF generation libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Set a custom font for the page -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* gray-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* gray-400 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 antialiased">
    <!-- This is where the React app will be rendered -->
    <div id="root"></div>

    <!-- The React component code, transpiled by Babel -->
    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- Custom UI Components ---
        const Button = ({ children, onClick, variant = 'default', className = '', ...props }) => {
          const baseClasses = 'inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 h-10 px-4 py-2';
          const variantClasses = {
            default: 'bg-violet-600 text-white hover:bg-violet-700 focus-visible:ring-violet-500',
            secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 focus-visible:ring-gray-400',
            outline: 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-100 hover:text-gray-900 focus-visible:ring-gray-400',
            success: 'bg-lime-600 text-white hover:bg-lime-700 focus-visible:ring-lime-500',
            danger: 'bg-rose-600 text-white hover:bg-rose-700 focus-visible:ring-rose-500',
            ghost: 'hover:bg-gray-100 text-gray-700 hover:text-gray-900 focus-visible:ring-gray-400',
          };
          return (
            <button onClick={onClick} className={`${baseClasses} ${variantClasses[variant]} ${className}`} {...props}>
              {children}
            </button>
          );
        };

        const Input = ({ type = 'text', value, onChange, placeholder, className = '', ...props }) => {
          const baseClasses = 'flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-gray-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-violet-500 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50';
          return (
            <input
              type={type}
              value={value}
              onChange={onChange}
              placeholder={placeholder}
              className={`${baseClasses} ${className}`}
              {...props}
            />
          );
        };

        const Select = ({ value, onChange, options = [], className = '' }) => {
          const baseClasses = 'flex h-10 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-violet-500 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1';
          return (
            <select value={value} onChange={onChange} className={`${baseClasses} ${className}`}>
              {options.map((option, index) => (
                <option key={index} value={option.value}>{option.label}</option>
              ))}
            </select>
          );
        };

        const Card = ({ children, className = '' }) => {
          return (
            <div className={`rounded-xl border bg-white shadow-lg p-6 ${className}`}>
              {children}
            </div>
          );
        };
        
        // --- Custom SVG Icons ---
        const ToggleLeftIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <rect x="2" y="6" width="20" height="12" rx="6" />
            <circle cx="8" cy="12" r="4" />
          </svg>
        );

        const ToggleRightIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <rect x="2" y="6" width="20" height="12" rx="6" />
            <circle cx="16" cy="12" r="4" />
          </svg>
        );

        const LoadingSpinner = () => (
          <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        );

        const DownloadIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" x2="12" y1="15" y2="3" />
          </svg>
        );

        const MessageSquareIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
          </svg>
        );

        const HomeIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
            <polyline points="9 22 9 12 15 12 15 22" />
          </svg>
        );
        
        const MenuIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <line x1="4" y1="12" x2="20" y2="12" />
            <line x1="4" y1="6" x2="20" y2="6" />
            <line x1="4" y1="18" x2="20" y2="18" />
          </svg>
        );

        const XIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        );

        const CalendarIcon = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
            <line x1="16" y1="2" x2="16" y2="6" />
            <line x1="8" y1="2" x2="8" y2="6" />
            <line x1="3" y1="10" x2="21" y2="10" />
          </svg>
        );

        // --- Timetable Table Components ---
        const ClassTimetableTable = ({ className, timetableData, workingDayLabels, periodsPerDay, onExport, isExporting, halfDaysConfig }) => {
          return (
            <div className="space-y-4 overflow-x-auto">
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                <h3 className="text-xl font-bold text-violet-700 mb-2 sm:mb-0">{className}</h3>
                <Button
                  variant="secondary"
                  onClick={() => onExport(className)}
                  disabled={isExporting}
                  className="flex items-center space-x-2 text-sm w-full sm:w-auto"
                >
                  {isExporting ? <LoadingSpinner /> : <DownloadIcon />}
                  <span>{isExporting ? 'Exporting...' : 'Export to PDF'}</span>
                </Button>
              </div>
              <table className="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-3 py-3 sm:px-6 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Period</th>
                    {workingDayLabels.map(day => (
                      <th key={day} className="px-3 py-3 sm:px-6 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                        {day} {halfDaysConfig[day] ? '(Half-Day)' : ''}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {Array.from({ length: periodsPerDay }).map((_, periodIndex) => (
                    <tr key={periodIndex} className="hover:bg-gray-50 transition-colors">
                      <td className="px-3 py-4 sm:px-6 whitespace-nowrap font-medium text-gray-900 text-sm">{periodIndex + 1}</td>
                      {workingDayLabels.map(day => {
                        const lesson = timetableData[className]?.[day]?.[periodIndex] || { subject: 'Free', teacher: null };
                        const isFree = lesson.subject === 'Free' || lesson.subject === 'Recess' || lesson.subject === 'Half-Day Break';
                        const bgColor = lesson.subject === 'Recess' ? 'bg-lime-100 text-lime-800' :
                                        lesson.subject === 'Half-Day Break' ? 'bg-gray-200 text-gray-600' :
                                        isFree ? 'bg-gray-100 text-gray-500' : 'bg-violet-50 text-violet-800';
                        return (
                          <td key={day} className="px-3 py-4 sm:px-6 whitespace-nowrap">
                            <div className={`p-2 rounded-md ${bgColor}`} style={{minWidth: '100px'}}>
                              <div className="font-semibold text-sm">{lesson.subject}</div>
                              <div className="text-xs text-gray-600">{!isFree && `(${lesson.teacher})`}</div>
                            </div>
                          </td>
                        );
                      })}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          );
        };

        const TeacherTimetableTable = ({ teacherName, timetableData, workingDayLabels, periodsPerDay, onExport, isExporting, halfDaysConfig }) => {
          return (
            <div className="space-y-4 overflow-x-auto">
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                <h3 className="text-xl font-bold text-violet-700 mb-2 sm:mb-0">{teacherName}</h3>
                <Button
                  variant="secondary"
                  onClick={() => onExport(teacherName)}
                  disabled={isExporting}
                  className="flex items-center space-x-2 text-sm w-full sm:w-auto"
                >
                  {isExporting ? <LoadingSpinner /> : <DownloadIcon />}
                  <span>{isExporting ? 'Exporting...' : 'Export to PDF'}</span>
                </Button>
              </div>
              <table className="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-3 py-3 sm:px-6 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Period</th>
                    {workingDayLabels.map(day => (
                      <th key={day} className="px-3 py-3 sm:px-6 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">
                        {day} {halfDaysConfig[day] ? '(Half-Day)' : ''}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {Array.from({ length: periodsPerDay }).map((_, periodIndex) => (
                    <tr key={periodIndex} className="hover:bg-gray-50 transition-colors">
                      <td className="px-3 py-4 sm:px-6 whitespace-nowrap font-medium text-gray-900 text-sm">{periodIndex + 1}</td>
                      {workingDayLabels.map(day => {
                        const lesson = timetableData[teacherName]?.[day]?.[periodIndex] || { className: 'Free' };
                        const isFree = lesson.className === 'Free' || lesson.className === 'Recess' || lesson.className === 'Half-Day Break';
                        const bgColor = lesson.className === 'Recess' ? 'bg-lime-100 text-lime-800' :
                                        lesson.className === 'Half-Day Break' ? 'bg-gray-200 text-gray-600' :
                                        isFree ? 'bg-gray-100 text-gray-500' : 'bg-rose-50 text-rose-800';
                        return (
                          <td key={day} className="px-3 py-4 sm:px-6 whitespace-nowrap">
                            <div className={`p-2 rounded-md ${bgColor}`} style={{minWidth: '100px'}}>
                              <div className="font-semibold text-sm">{lesson.className}</div>
                              <div className="text-xs text-gray-600">{!isFree && `(${lesson.subject})`}</div>
                            </div>
                          </td>
                        );
                      })}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          );
        };

        // --- Landing Page ---
        const LandingPage = ({ onNavigate }) => {
          return (
            <div className="flex flex-col items-center justify-center min-h-screen p-4 md:p-6 text-center bg-gradient-to-br from-violet-50 to-rose-100">
              <Card className="max-w-3xl mx-auto p-8 md:p-12 shadow-2xl border-none">
                <h1 className="text-4xl sm:text-6xl md:text-7xl font-extrabold tracking-tight text-gray-900 leading-tight">
                  Hello, I'm <span className="text-violet-600">Ayaan</span>
                </h1>
                <p className="mt-6 max-w-xl text-base sm:text-lg text-gray-700 leading-relaxed">
                  Welcome to the Timetable App! I’ve built this platform to make managing schedules simple, clear, and stress-free. Whether you’re a student, teacher, or school, this app helps you stay organized with easy access to classes, subjects, and activities—all in one place. My goal is to save your time and keep everything well-planned.
                </p>
                <div className="mt-10 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                  <Button onClick={() => onNavigate('app')} className="px-8 py-3 text-lg w-full sm:w-auto shadow-lg hover:shadow-xl">
                    Explore the App
                  </Button>
                </div>
              </Card>
            </div>
          );
        };

        // --- Contact Page ---
        const ContactPage = () => {
          const [formState, setFormState] = React.useState({ name: '', email: '', message: '' });

          const handleChange = (e) => {
            const { name, value } = e.target;
            setFormState(prev => ({ ...prev, [name]: value }));
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            console.log('Contact form submitted:', formState);
            alert('Thank you for your message! (Form data logged to console)');
            setFormState({ name: '', email: '', message: '' });
          };

          return (
            <div className="p-4 md:p-8 bg-gray-50 min-h-[calc(100vh-64px)] flex items-center justify-center">
              <div className="max-w-xl mx-auto w-full">
                <Card className="space-y-6">
                  <h2 className="text-3xl font-bold text-gray-900 text-center">Contact Me</h2>
                  <p className="text-gray-600 mt-2 text-center">
                    Feel free to reach out with any questions or collaboration opportunities.
                  </p>
                  <form onSubmit={handleSubmit} className="mt-6 space-y-4">
                    <div>
                      <label htmlFor="name" className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                      <Input
                        id="name"
                        name="name"
                        type="text"
                        value={formState.name}
                        onChange={handleChange}
                        required
                      />
                    </div>
                    <div>
                      <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                      <Input
                        id="email"
                        name="email"
                        type="email"
                        value={formState.email}
                        onChange={handleChange}
                        required
                      />
                    </div>
                    <div>
                      <label htmlFor="message" className="block text-sm font-medium text-gray-700 mb-1">Message</label>
                      <textarea
                        id="message"
                        name="message"
                        rows="4"
                        value={formState.message}
                        onChange={handleChange}
                        required
                        className="flex min-h-[80px] w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm ring-offset-background placeholder:text-gray-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-violet-500 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                      ></textarea>
                    </div>
                    <Button type="submit" className="w-full bg-violet-600 hover:bg-violet-700">
                      Send Message
                    </Button>
                  </form>
                </Card>
              </div>
              </div>
          );
        };


        // --- Main Application Component ---
        const TimetableApp = () => {
          // State for settings
          const [teachers, setTeachers] = useState(['Mr. Smith', 'Ms. Jones', 'Dr. Williams']);
          const [classes, setClasses] = useState(['3A', '3B', '4A', '4B']);
          const [subjects, setSubjects] = useState(['English', 'Maths', 'Science', 'History', 'Art']);
          const [periodsPerDay, setPeriodsPerDay] = useState(6);
          const [workingDays, setWorkingDays] = useState(5);
          const [offDays, setOffDays] = useState(['Saturday', 'Sunday']);
          const [halfDaysConfig, setHalfDaysConfig] = useState({}); // { 'Monday': true, 'Tuesday': false }
          const [recessPeriods, setRecessPeriods] = useState([]); // [2, 4] means recess after period 2 and 4

          // State for assignments
          const [assignments, setAssignments] = useState({
            '3A': { 'English': 'Mr. Smith', 'Maths': 'Ms. Jones', 'Science': 'Dr. Williams', 'History': 'Mr. Smith', 'Art': 'Ms. Jones', },
            '3B': { 'English': 'Ms. Jones', 'Maths': 'Mr. Smith', 'Science': 'Dr. Williams', 'History': 'Ms. Jones', 'Art': 'Mr. Smith', },
            '4A': { 'English': 'Mr. Smith', 'Maths': 'Dr. Williams', 'Science': 'Ms. Jones', 'History': 'Dr. Williams', 'Art': 'Ms. Jones', },
            '4B': { 'English': 'Dr. Williams', 'Maths': 'Mr. Smith', 'Science': 'Ms. Jones', 'History': 'Mr. Smith', 'Art': 'Dr. Williams', },
          });

          // State for teacher max periods per day
          const [teacherMaxPeriods, setTeacherMaxPeriods] = useState({}); // { 'Mr. Smith': 6, 'Ms. Jones': 6 }

          // Initialize teacherMaxPeriods when teachers change
          useEffect(() => {
            const newMaxPeriods = {};
            teachers.forEach(teacher => {
              newMaxPeriods[teacher] = teacherMaxPeriods[teacher] || periodsPerDay; // Default to periodsPerDay
            });
            setTeacherMaxPeriods(newMaxPeriods);
          }, [teachers, periodsPerDay]);


          // State for the generated timetable
          const [timetable, setTimetable] = useState(null);
          const [teacherTimetable, setTeacherTimetable] = useState(null); // New state for teacher timetable
          const [showSettings, setShowSettings] = useState(true);
          const [currentView, setCurrentView] = useState('class'); // New state for view toggle
          const [isGenerating, setIsGenerating] = useState(false); // To disable buttons while generating
          const [generationError, setGenerationError] = useState('');
          const [isExportingAll, setIsExportingAll] = useState(false);
          const [isExporting, setIsExporting] = useState({ class: {}, teacher: {} });
          const [areLibrariesLoaded, setAreLibrariesLoaded] = useState(false);


          // Helper functions for adding/removing items
          const addItem = (item, setList) => {
            if (item.trim() !== '') {
              setList(prev => [...prev, item.trim()]);
            }
          };

          const removeItem = (itemToRemove, setList) => {
            setList(prev => prev.filter(item => item !== itemToRemove));
          };

          const weekDays = useMemo(() => ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'], []);
          const workingDayLabels = useMemo(() => {
            const validDays = weekDays.filter(day => !offDays.includes(day));
            return validDays.slice(0, workingDays);
          }, [workingDays, weekDays, offDays]);

          const handleAssignmentChange = (className, subject, teacher) => {
            setAssignments(prev => ({
              ...prev,
              [className]: {
                ...prev[className],
                [subject]: teacher,
              },
            }));
          };

          const handleRecessPeriodChange = (period, isChecked) => {
            if (isChecked) {
              setRecessPeriods(prev => [...prev, period].sort((a, b) => a - b));
            } else {
              setRecessPeriods(prev => prev.filter(p => p !== period));
            }
          };

          const handleHalfDayChange = (day, isChecked) => {
            setHalfDaysConfig(prev => ({
                ...prev,
                [day]: isChecked
            }));
          };

          const handleTeacherMaxPeriodsChange = (teacher, value) => {
            setTeacherMaxPeriods(prev => ({
                ...prev,
                [teacher]: parseInt(value) || 0
            }));
          };

          // The core timetable generation function, now with a parameter to control double periods
          const generateTimetable = (allowDoublePeriods = true) => {
            setIsGenerating(true);
            setGenerationError('');
            setTimetable(null);
            setTeacherTimetable(null);

            setTimeout(() => {
                // --- Initialize Schedules ---
                const newTimetable = {};
                const teacherSchedule = {};
                const teacherDailyPeriodCount = {}; // Tracks periods assigned to each teacher per day

                classes.forEach(className => {
                  newTimetable[className] = {};
                });
                teachers.forEach(teacher => {
                  teacherSchedule[teacher] = {};
                  teacherDailyPeriodCount[teacher] = {};
                });

                // --- Pre-fill Recess and Half-Day Breaks ---
                workingDayLabels.forEach(day => {
                    const currentPeriodsPerDay = halfDaysConfig[day] ? Math.ceil(periodsPerDay / 2) : periodsPerDay;

                    classes.forEach(className => {
                        newTimetable[className][day] = new Array(periodsPerDay).fill({ subject: 'Free', teacher: null });
                    });
                    teachers.forEach(teacher => {
                        teacherSchedule[teacher][day] = new Array(periodsPerDay).fill(null);
                        teacherDailyPeriodCount[teacher][day] = 0;
                    });

                    for (let p = 0; p < periodsPerDay; p++) {
                        const periodNum = p + 1;
                        if (recessPeriods.includes(periodNum)) {
                            classes.forEach(className => {
                                newTimetable[className][day][p] = { subject: 'Recess', teacher: null };
                            });
                            teachers.forEach(teacher => {
                                teacherSchedule[teacher][day][p] = { className: 'Recess', subject: null };
                            });
                        } else if (periodNum > currentPeriodsPerDay) { // Periods beyond half-day limit
                            classes.forEach(className => {
                                newTimetable[className][day][p] = { subject: 'Half-Day Break', teacher: null };
                            });
                            teachers.forEach(teacher => {
                                teacherSchedule[teacher][day][p] = { className: 'Half-Day Break', subject: null };
                            });
                        }
                    }
                });

                // --- Prepare Assignments ---
                const allAssignments = [];
                classes.forEach(className => {
                  const classAssignments = assignments[className] || {};
                  subjects.forEach(subject => {
                    const teacher = classAssignments[subject] || 'Unassigned';
                    if (teacher !== 'Unassigned') {
                      // Calculate total available slots for this class, excluding recess/half-day breaks
                      let classAvailableSlots = 0;
                      workingDayLabels.forEach(day => {
                          const actualPeriods = halfDaysConfig[day] ? Math.ceil(periodsPerDay / 2) : periodsPerDay;
                          classAvailableSlots += actualPeriods - recessPeriods.filter(rp => rp <= actualPeriods).length;
                      });

                      // Distribute periods per subject, ensuring at least one if possible
                      // This is a heuristic; perfect distribution is hard with many constraints
                      const periodsPerSubject = Math.max(1, Math.floor(classAvailableSlots / subjects.length));

                      for (let i = 0; i < periodsPerSubject; i++) {
                        allAssignments.push({ className, subject, teacher });
                      }
                    }
                  });
                });

                // Shuffle assignments for randomness
                const shuffledAssignments = allAssignments.sort(() => Math.random() - 0.5);

                // Track subject placement per day for 'no double periods' constraint
                const classSubjectDayTracker = {};
                classes.forEach(className => {
                    classSubjectDayTracker[className] = {};
                    subjects.forEach(subject => {
                        classSubjectDayTracker[className][subject] = new Set(); // Stores days where subject is placed
                    });
                });

                // --- Place Assignments ---
                const unplacedAssignments = [];

                shuffledAssignments.forEach(assignment => {
                  const { className, subject, teacher } = assignment;
                  let placed = false;
                  const maxAttemptsPerAssignment = periodsPerDay * workingDayLabels.length * 5; // Increased attempts

                  // Collect all possible slots for this assignment
                  const possibleSlots = [];
                  workingDayLabels.forEach(day => {
                      const currentPeriodsForDay = halfDaysConfig[day] ? Math.ceil(periodsPerDay / 2) : periodsPerDay;
                      for (let p = 0; p < currentPeriodsForDay; p++) {
                          const periodNum = p + 1;
                          // Only consider non-recess and non-half-day-break periods
                          if (!recessPeriods.includes(periodNum) && newTimetable[className][day][p].subject === 'Free') {
                              possibleSlots.push({ day, period: p });
                          }
                      }
                  });
                  // Shuffle possible slots to ensure randomness in selection
                  possibleSlots.sort(() => Math.random() - 0.5);

                  for (const { day, period } of possibleSlots) {
                    if (placed) break; // Already placed this assignment

                    const isClassSlotFree = newTimetable[className]?.[day]?.[period]?.subject === 'Free';
                    const isTeacherSlotFree = teacherSchedule[teacher]?.[day]?.[period] === null;
                    const teacherDailyLimitReached = teacherMaxPeriods[teacher] && teacherDailyPeriodCount[teacher][day] >= teacherMaxPeriods[teacher];

                    const isSubjectAlreadyOnDay = classSubjectDayTracker[className][subject].has(day);
                    const isPlacementValid = allowDoublePeriods || !isSubjectAlreadyOnDay;

                    if (isClassSlotFree && isTeacherSlotFree && !teacherDailyLimitReached && isPlacementValid) {
                      newTimetable[className][day][period] = { subject, teacher };
                      teacherSchedule[teacher][day][period] = { className, subject };
                      classSubjectDayTracker[className][subject].add(day);
                      teacherDailyPeriodCount[teacher][day] = (teacherDailyPeriodCount[teacher][day] || 0) + 1;
                      placed = true;
                    }
                  }

                  if (!placed) {
                    unplacedAssignments.push(assignment);
                  }
                });

                // --- Handle Unplaced Assignments (Report errors) ---
                if (unplacedAssignments.length > 0) {
                    const errorDetails = unplacedAssignments.map(a => `${a.subject} for ${a.className} (Teacher: ${a.teacher})`).join(', ');
                    setGenerationError(`Could not place ${unplacedAssignments.length} assignments: ${errorDetails}. Try adjusting settings (e.g., increase periods, reduce teacher max periods, allow double periods, check assignments).`);
                    console.error("Unplaced assignments:", unplacedAssignments);
                }


                setTimetable(newTimetable);
                setTeacherTimetable(teacherSchedule);
                setIsGenerating(false);
            }, 500); // Add a small delay for a better user experience
          };


          const loadScript = (src) => {
            return new Promise((resolve, reject) => {
              const script = document.createElement('script');
              script.src = src;
              script.onload = () => resolve(true);
              script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
              document.head.appendChild(script);
            });
          };

          const loadPdfLibraries = async () => {
            if (areLibrariesLoaded) return;
            try {
              await Promise.all([
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'),
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js')
              ]);
              setAreLibrariesLoaded(true);
            } catch (error) {
              console.error('[ERROR] Error loading PDF libraries:', error);
            }
          };

          useEffect(() => {
            loadPdfLibraries();
          }, []);

          return (
            <div className="min-h-screen bg-gray-100 p-4 font-sans text-gray-900">
              <div className="max-w-7xl mx-auto space-y-8">
                <h1 className="text-3xl sm:text-4xl font-extrabold text-center text-gray-900 leading-tight">Timetable Maker</h1>
                <p className="text-center text-base sm:text-lg text-gray-700 max-w-2xl mx-auto">
                  Set up your teachers, classes, and subjects, then assign teachers to subjects to generate a conflict-free timetable.
                </p>

                {/* Settings and Assignments */}
                <div className="space-y-6">
                  {/* Toggle Settings Button */}
                  <div className="flex justify-end">
                    <Button variant="outline" onClick={() => setShowSettings(!showSettings)} className="flex items-center space-x-2 text-gray-700 hover:bg-gray-100">
                      {showSettings ? <ToggleLeftIcon className="h-5 w-5" /> : <ToggleRightIcon className="h-5 w-5" />}
                      <span>{showSettings ? 'Hide Settings' : 'Show Settings'}</span>
                    </Button>
                  </div>

                  {showSettings && (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                      {/* Settings Card */}
                      <Card className="space-y-6">
                        <h2 className="text-2xl font-bold text-violet-700">School Details</h2>
                        <div className="space-y-4">
                          {/* Teachers */}
                          <div>
                            <h3 className="font-semibold text-lg text-gray-800 mb-2">Teachers</h3>
                            <div className="space-y-2">
                              <Input
                                placeholder="Add new teacher"
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    addItem(e.target.value, setTeachers);
                                    e.target.value = '';
                                  }
                                }}
                              />
                              <div className="flex flex-wrap gap-2 pt-2">
                                {teachers.map(teacher => (
                                  <span key={teacher} className="bg-violet-100 text-violet-800 px-3 py-1 rounded-full flex items-center space-x-1 text-sm">
                                    <span>{teacher}</span>
                                    <button onClick={() => removeItem(teacher, setTeachers)} className="text-violet-500 hover:text-violet-700 font-bold ml-1">
                                      &times;
                                    </button>
                                  </span>
                                ))}
                              </div>
                            </div>
                          </div>

                          {/* Classes */}
                          <div>
                            <h3 className="font-semibold text-lg text-gray-800 mb-2">Classes</h3>
                            <div className="space-y-2">
                              <Input
                                placeholder="Add new class"
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    addItem(e.target.value, setClasses);
                                    e.target.value = '';
                                  }
                                }}
                              />
                              <div className="flex flex-wrap gap-2 pt-2">
                                {classes.map(cls => (
                                  <span key={cls} className="bg-violet-100 text-violet-800 px-3 py-1 rounded-full flex items-center space-x-1 text-sm">
                                    <span>{cls}</span>
                                    <button onClick={() => removeItem(cls, setClasses)} className="text-violet-500 hover:text-violet-700 font-bold ml-1">
                                      &times;
                                    </button>
                                  </span>
                                ))}
                              </div>
                            </div>
                          </div>

                          {/* Subjects */}
                          <div>
                            <h3 className="font-semibold text-lg text-gray-800 mb-2">Subjects</h3>
                            <div className="space-y-2">
                              <Input
                                placeholder="Add new subject"
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    addItem(e.target.value, setSubjects);
                                    e.target.value = '';
                                  }
                                }}
                              />
                              <div className="flex flex-wrap gap-2 pt-2">
                                {subjects.map(subject => (
                                  <span key={subject} className="bg-violet-100 text-violet-800 px-3 py-1 rounded-full flex items-center space-x-1 text-sm">
                                    <span>{subject}</span>
                                    <button onClick={() => removeItem(subject, setSubjects)} className="text-violet-500 hover:text-violet-700 font-bold ml-1">
                                      &times;
                                    </button>
                                  </span>
                                ))}
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Periods and Days */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                            <label className="font-semibold text-sm text-gray-800 mb-1 block">Periods per Day</label>
                            <Input
                              type="number"
                              value={periodsPerDay}
                              onChange={(e) => setPeriodsPerDay(Math.max(1, parseInt(e.target.value) || 1))}
                              min="1"
                            />
                          </div>
                          <div>
                            <label className="font-semibold text-sm text-gray-800 mb-1 block">Working Days</label>
                            <Input
                              type="number"
                              value={workingDays}
                              onChange={(e) => setWorkingDays(Math.max(1, Math.min(7, parseInt(e.target.value) || 1)))}
                              min="1"
                              max="7"
                            />
                          </div>
                        </div>

                        {/* Off Days */}
                        <div>
                          <h3 className="font-semibold text-lg text-gray-800 mb-2">Off Days</h3>
                          <div className="flex flex-wrap gap-x-4 gap-y-2 mt-2">
                            {weekDays.map(day => (
                              <div key={`off-day-${day}`} className="flex items-center space-x-2">
                                <input
                                  type="checkbox"
                                  id={`off-day-${day}`}
                                  checked={offDays.includes(day)}
                                  onChange={(e) => {
                                    if (e.target.checked) {
                                      setOffDays([...offDays, day]);
                                    } else {
                                      setOffDays(offDays.filter(d => d !== day));
                                    }
                                  }}
                                  className="h-4 w-4 text-violet-600 border-gray-300 rounded focus:ring-violet-500"
                                />
                                <label htmlFor={`off-day-${day}`} className="text-sm font-medium text-gray-700">{day}</label>
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Half Days */}
                        <div>
                          <h3 className="font-semibold text-lg text-gray-800 mb-2">Half-Days</h3>
                          <p className="text-sm text-gray-600 mb-2">Select days that will have half the periods (rounded up).</p>
                          <div className="flex flex-wrap gap-x-4 gap-y-2 mt-2">
                            {workingDayLabels.map(day => (
                              <div key={`half-day-${day}`} className="flex items-center space-x-2">
                                <input
                                  type="checkbox"
                                  id={`half-day-${day}`}
                                  checked={halfDaysConfig[day] || false}
                                  onChange={(e) => handleHalfDayChange(day, e.target.checked)}
                                  className="h-4 w-4 text-violet-600 border-gray-300 rounded focus:ring-violet-500"
                                />
                                <label htmlFor={`half-day-${day}`} className="text-sm font-medium text-gray-700">{day}</label>
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Recess Periods */}
                        <div>
                          <h3 className="font-semibold text-lg text-gray-800 mb-2">Recess Periods</h3>
                          <p className="text-sm text-gray-600 mb-2">Select periods after which a recess will occur.</p>
                          <div className="flex flex-wrap gap-x-4 gap-y-2 mt-2">
                            {Array.from({ length: periodsPerDay }).map((_, i) => (
                              <div key={`recess-${i + 1}`} className="flex items-center space-x-2">
                                <input
                                  type="checkbox"
                                  id={`recess-${i + 1}`}
                                  checked={recessPeriods.includes(i + 1)}
                                  onChange={(e) => handleRecessPeriodChange(i + 1, e.target.checked)}
                                  className="h-4 w-4 text-violet-600 border-gray-300 rounded focus:ring-violet-500"
                                />
                                <label htmlFor={`recess-${i + 1}`} className="text-sm font-medium text-gray-700">After Period {i + 1}</label>
                              </div>
                            ))}
                          </div>
                        </div>
                      </Card>

                      {/* Assignments Card */}
                      <Card className="space-y-6">
                        <h2 className="text-2xl font-bold text-violet-700">Teacher Assignments & Limits</h2>
                        {classes.length > 0 && subjects.length > 0 ? (
                          <div className="space-y-6 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                            {/* Teacher Max Periods */}
                            <div className="space-y-4 border-b border-gray-200 pb-4">
                                <h3 className="text-lg sm:text-xl font-semibold text-gray-900">Max Periods per Teacher (per day)</h3>
                                {teachers.map(teacher => (
                                    <div key={`max-periods-${teacher}`} className="flex items-center space-x-4">
                                        <span className="w-1/2 font-medium text-gray-700">{teacher}</span>
                                        <Input
                                            type="number"
                                            value={teacherMaxPeriods[teacher] || periodsPerDay}
                                            onChange={(e) => handleTeacherMaxPeriodsChange(teacher, e.target.value)}
                                            min="0"
                                            max={periodsPerDay}
                                            className="w-1/2"
                                        />
                                    </div>
                                ))}
                            </div>

                            {/* Subject Assignments */}
                            {classes.map(cls => (
                              <div key={cls} className="space-y-2 border-b border-gray-200 pb-4 last:border-b-0">
                                <h3 className="text-lg sm:text-xl font-semibold text-gray-900">{cls}</h3>
                                {subjects.map(subject => (
                                  <div key={subject} className="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                                    <span className="w-full sm:w-1/3 font-medium text-gray-700">{subject}</span>
                                    <Select
                                      value={assignments[cls]?.[subject] || ''}
                                      onChange={(e) => handleAssignmentChange(cls, subject, e.target.value)}
                                      options={[{ value: '', label: 'Select Teacher' }, ...teachers.map(t => ({ value: t, label: t })) ]}
                                      className="w-full sm:w-2/3"
                                    />
                                  </div>
                                ))}
                              </div>
                            ))}
                          </div>
                        ) : (
                          <p className="text-gray-500 italic">Please add classes and subjects in the settings to make assignments.</p>
                        )}
                      </Card>
                    </div>
                  )}
                </div>

                {/* Generate Buttons */}
                <div className="flex flex-col sm:flex-row justify-center pt-6 space-y-4 sm:space-y-0 sm:space-x-4">
                  <Button onClick={() => generateTimetable(true)} className="px-8 py-3 text-lg bg-violet-600 hover:bg-violet-700 w-full sm:w-auto shadow-md" disabled={isGenerating}>
                    {isGenerating ? <LoadingSpinner /> : 'Generate Timetable (Allow Double Periods)'}
                  </Button>
                  <Button onClick={() => generateTimetable(false)} className="px-8 py-3 text-lg bg-rose-600 hover:bg-rose-700 w-full sm:w-auto shadow-md" disabled={isGenerating}>
                    {isGenerating ? <LoadingSpinner /> : 'Generate Timetable (No Double Periods)'}
                  </Button>
                  {timetable && (
                    <Button
                      variant="secondary"
                      onClick={handleExportAll}
                      disabled={isExportingAll || Object.values(isExporting[currentView]).some(Boolean)}
                      className="px-8 py-3 text-lg flex items-center justify-center space-x-2 w-full sm:w-auto shadow-md"
                    >
                      {isExportingAll && <LoadingSpinner className="text-gray-800" />}
                      <span>{isExportingAll ? 'Exporting All...' : 'Export All to PDF'}</span>
                    </Button>
                  )}
                </div>

                {generationError && (
                    <div className="bg-rose-100 border border-rose-400 text-rose-700 px-4 py-3 rounded relative mt-4" role="alert">
                        <strong className="font-bold">Generation Error:</strong>
                        <span className="block sm:inline"> {generationError}</span>
                    </div>
                )}

                {/* Timetable Display */}
                {timetable && (
                  <div className="pt-8">
                    <div className="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4 mb-6">
                      <Button
                        variant={currentView === 'class' ? 'default' : 'outline'}
                        onClick={() => setCurrentView('class')}
                        className={`w-full sm:w-auto ${currentView === 'class' ? 'bg-violet-600 text-white' : 'text-gray-700 hover:bg-gray-100'}`}
                      >
                        Class Timetables
                      </Button>
                      <Button
                        variant={currentView === 'teacher' ? 'default' : 'outline'}
                        onClick={() => setCurrentView('teacher')}
                        className={`w-full sm:w-auto ${currentView === 'teacher' ? 'bg-violet-600 text-white' : 'text-gray-700 hover:bg-gray-100'}`}
                      >
                        Teacher Timetables
                      </Button>
                    </div>

                    {currentView === 'class' && (
                      <div className="space-y-8">
                        <h2 className="text-2xl sm:text-3xl font-bold text-center text-gray-900 mb-6">Generated Class Timetables</h2>
                        {classes.map(cls => (
                          <Card key={cls} id={`timetable-class-${cls}`} className="space-y-4 overflow-x-auto">
                            <ClassTimetableTable
                              className={cls}
                              timetableData={timetable}
                              workingDayLabels={workingDayLabels}
                              periodsPerDay={periodsPerDay}
                              onExport={(name) => exportTimetableToPDF(name, 'class')}
                              isExporting={isExporting.class[cls]}
                              halfDaysConfig={halfDaysConfig}
                            />
                          </Card>
                        ))}
                      </div>
                    )}

                    {currentView === 'teacher' && teacherTimetable && (
                      <div className="space-y-8">
                        <h2 className="text-2xl sm:text-3xl font-bold text-center text-gray-900 mb-6">Generated Teacher Timetables</h2>
                        {teachers.map(teacher => (
                          <Card key={teacher} id={`timetable-teacher-${teacher}`} className="space-y-4 overflow-x-auto">
                            <TeacherTimetableTable
                              teacherName={teacher}
                              timetableData={teacherTimetable}
                              workingDayLabels={workingDayLabels}
                              periodsPerDay={periodsPerDay}
                              onExport={(name) => exportTimetableToPDF(name, 'teacher')}
                              isExporting={isExporting.teacher[teacher]}
                              halfDaysConfig={halfDaysConfig}
                            />
                          </Card>
                        ))}
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          );
        };


        // --- Main App Component (Handles Navigation) ---
        const App = () => {
          const [currentPage, setCurrentPage] = useState('landing');
          const [isSidebarOpen, setIsSidebarOpen] = useState(false);
          const sidebarRef = useRef(null);

          const renderPage = () => {
            switch (currentPage) {
              case 'app':
                return <TimetableApp />;
              case 'contact':
                return <ContactPage />;
              default:
                return <LandingPage onNavigate={handleNavigate} />;
            }
          };

          const handleNavigate = (page) => {
            setCurrentPage(page);
            setIsSidebarOpen(false); // Close sidebar on navigation
          };

          useEffect(() => {
            const handleResize = () => {
              if (window.innerWidth >= 768) { // md breakpoint in Tailwind
                setIsSidebarOpen(true);
              } else {
                setIsSidebarOpen(false);
              }
            };
            window.addEventListener('resize', handleResize);
            handleResize(); // Set initial state
            return () => window.removeEventListener('resize', handleResize);
          }, []);

          // Close sidebar on outside click
          useEffect(() => {
            const handleClickOutside = (event) => {
              if (sidebarRef.current && !sidebarRef.current.contains(event.target)) {
                if (window.innerWidth < 768) {
                    setIsSidebarOpen(false);
                }
              }
            };
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
          }, [isSidebarOpen]);

          const isLandingPage = currentPage === 'landing';

          return (
            <div className="flex flex-col md:flex-row min-h-screen bg-gray-100 font-sans text-gray-900">
              {/* Mobile Header and Sidebar Toggle */}
              {!isLandingPage && (
                <div className="md:hidden flex items-center justify-between p-4 bg-white shadow-lg sticky top-0 z-50 border-b border-gray-200">
                  <span className="text-xl font-bold text-violet-600">Ayaan's Timetable</span>
                  <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-violet-500">
                    {isSidebarOpen ? <XIcon className="h-6 w-6 text-gray-700" /> : <MenuIcon className="h-6 w-6 text-gray-700" />}
                  </button>
                </div>
              )}

              {/* Sidebar */}
              <aside
                ref={sidebarRef}
                className={`fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-xl transform transition-transform duration-300 ease-in-out md:static md:translate-x-0 md:w-64 md:border-r md:shadow-none p-4 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} ${isLandingPage ? 'hidden' : ''}`}
              >
                <div className="flex flex-col h-full">
                  <div className="flex items-center justify-between md:justify-center mb-8">
                    <span className="text-2xl font-bold text-violet-600">Ayaan's Timetable</span>
                    <button onClick={() => setIsSidebarOpen(false)} className="p-2 rounded-md hover:bg-gray-100 focus:outline-none md:hidden">
                      <XIcon className="h-6 w-6 text-gray-700" />
                    </button>
                  </div>
                  <nav className="flex-1 space-y-2">
                    <Button
                      variant={currentPage === 'landing' ? 'default' : 'ghost'}
                      className={`flex items-center justify-start w-full space-x-3 text-base py-2.5 ${currentPage === 'landing' ? 'bg-violet-50 text-violet-700 hover:bg-violet-100' : 'text-gray-700 hover:bg-gray-100'}`}
                      onClick={() => handleNavigate('landing')}
                    >
                      <HomeIcon className="w-5 h-5" />
                      <span>Home</span>
                    </Button>
                    <Button
                      variant={currentPage === 'app' ? 'default' : 'ghost'}
                      className={`flex items-center justify-start w-full space-x-3 text-base py-2.5 ${currentPage === 'app' ? 'bg-violet-50 text-violet-700 hover:bg-violet-100' : 'text-gray-700 hover:bg-gray-100'}`}
                      onClick={() => handleNavigate('app')}
                    >
                      <CalendarIcon className="w-5 h-5" />
                      <span>Timetable App</span>
                    </Button>
                    <Button
                      variant={currentPage === 'contact' ? 'default' : 'ghost'}
                      className={`flex items-center justify-start w-full space-x-3 text-base py-2.5 ${currentPage === 'contact' ? 'bg-violet-50 text-violet-700 hover:bg-violet-100' : 'text-gray-700 hover:bg-gray-100'}`}
                      onClick={() => handleNavigate('contact')}
                    >
                      <MessageSquareIcon className="w-5 h-5" />
                      <span>Contact</span>
                    </Button>
                  </nav>
                </div>
              </aside>

              {/* Main Content Area */}
              <main className="flex-1 overflow-y-auto">
                {isLandingPage ? (
                  renderPage()
                ) : (
                  <div className="max-w-7xl mx-auto p-4 md:p-6">
                    {renderPage()}
                  </div>
                )}
              </main>

              {/* Overlay for mobile view when sidebar is open */}
              {isSidebarOpen && (
                <div onClick={() => setIsSidebarOpen(false)} className="fixed inset-0 bg-black/50 z-40 md:hidden"></div>
              )}
            </div>
          );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
